<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính Tiền Lương</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern color scheme */
            --primary-color: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary-color: #0ea5e9;
            --accent-color: #22d3ee;
            --background-color: #f9fafb;
            --card-color: #ffffff;
            --text-color: #1e293b;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            
            /* Animation variables */
            --transition-fast: 0.15s ease-in-out;
            --transition-normal: 0.25s ease-in-out;
            --transition-slow: 0.4s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 100% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 0% 80%, rgba(34, 211, 238, 0.08) 0%, transparent 30%);
            background-attachment: fixed;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.5rem;
            letter-spacing: -0.5px;
            position: relative;
            display: inline-block;
        }

        h2 {
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.5rem;
        }

        h3 {
            color: var(--secondary-color);
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
            transition: all var(--transition-normal);
            border: 1px solid rgba(226, 232, 240, 0.8);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary-light);
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform var(--transition-normal);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .card:hover::before {
            transform: scaleY(1);
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-dark);
            font-size: 0.95rem;
            transition: color var(--transition-fast);
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all var(--transition-normal);
            background-color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background-color: #ffffff;
        }

        input[type="text"]::placeholder,
        input[type="number"]::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all var(--transition-normal);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.5s, opacity 1s;
        }

        .btn:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2);
        }

        .btn i {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .btn-danger {
            background-color: var(--danger-color);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-color: #dc2626;
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background-color: var(--success-color);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background-color: #059669;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }

        .member-card {
            position: relative;
            border-left: none;
            animation: fadeSlideIn var(--transition-slow) forwards;
        }

        .member-card::before {
            background-color: var(--secondary-color);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .member-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
        }

        .member-title::before {
            content: '\f007';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 8px;
            color: var(--secondary-color);
            opacity: 0.8;
        }

        .remove-member {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 18px;
            transition: all var(--transition-normal);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-member:hover {
            background-color: rgba(239, 68, 68, 0.1);
            transform: rotate(90deg);
        }

        .member-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .add-member-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px auto;
            padding: 12px 25px;
            background-color: var(--secondary-color);
            box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);
        }

        .add-member-btn:hover {
            background-color: #0284c7;
            box-shadow: 0 6px 15px rgba(14, 165, 233, 0.4);
        }

        .calculate-btn {
            display: block;
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            margin-top: 30px;
            border-radius: 14px;
        }

        .results {
            margin-top: 40px;
            opacity: 0;
            transform: translateY(20px);
            transition: all var(--transition-slow);
        }

        .results.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .result-card {
            margin-bottom: 20px;
            border-left: none;
            position: relative;
            border-top: 4px solid var(--success-color);
            animation: fadeSlideUp var(--transition-slow) forwards;
            animation-delay: calc(var(--item-index) * 0.1s);
            opacity: 0;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .result-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
        }

        .result-name::before {
            content: '\f007';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 10px;
            color: var(--success-color);
        }

        .result-amount {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }

        .amount-value {
            font-weight: 700;
            color: var(--success-color);
            background-color: rgba(16, 185, 129, 0.1);
            padding: 5px 12px;
            border-radius: 8px;
        }

        .amount-currency {
            margin-left: 5px;
            font-size: 0.95rem;
            font-weight: normal;
            color: var(--text-light);
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            font-size: 0.95rem;
            color: var(--text-light);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(226, 232, 240, 0.6);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .summary-card {
            background-color: rgba(249, 250, 251, 0.7);
            border-left: none;
            border-top: 4px solid var(--primary-color);
            backdrop-filter: blur(5px);
        }

        .summary-card h3 {
            color: var(--primary-color);
            font-size: 1.3rem;
        }

        @media (max-width: 768px) {
            .member-inputs {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn var(--transition-slow) ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Header and action buttons */
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }

        .title-container {
            text-align: center;
            animation: fadeIn var(--transition-slow);
            position: relative;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-top: 5px;
            margin-bottom: 20px;
            font-weight: 400;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }

        .history-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--accent-color);
            box-shadow: 0 4px 10px rgba(34, 211, 238, 0.25);
        }

        .history-btn:hover {
            background-color: #0891b2;
            box-shadow: 0 6px 15px rgba(34, 211, 238, 0.35);
        }

        /* Drawer styling */
        .drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: var(--card-color);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.08);
            transition: right var(--transition-normal);
            z-index: 1000;
            padding: 25px;
            overflow-y: auto;
            border-left: 1px solid var(--border-color);
        }

        .drawer.open {
            right: 0;
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .drawer-header h3 {
            color: var(--primary-color);
            margin-bottom: 0;
            font-size: 1.3rem;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .drawer-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: rotate(90deg);
        }

        .history-item {
            padding: 18px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-normal);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .history-item:hover {
            background-color: rgba(99, 102, 241, 0.05);
            transform: translateX(-5px);
        }

        .history-item-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
        }

        .history-item-title::before {
            content: '\f133';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 8px;
            color: var(--secondary-color);
        }

        .history-item-date {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
        }

        .history-item-date::before {
            content: '\f017';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 6px;
            opacity: 0.7;
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--warning-color);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
        }

        .export-btn:hover {
            background-color: #d97706;
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.4);
        }

        .backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(3px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .backdrop.open {
            opacity: 1;
            visibility: visible;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        /* Detail view styling */
        .detail-view {
            display: none;
            animation: fadeIn var(--transition-slow);
        }

        .detail-view.active {
            display: block;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            background-color: var(--text-light);
            box-shadow: 0 4px 10px rgba(100, 116, 139, 0.25);
        }

        .back-btn:hover {
            background-color: #475569;
        }

        .detail-month-title {
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.8rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            display: inline-block;
        }

        /* Input hints */
        .input-hint {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 6px;
            opacity: 0.8;
        }

        /* Responsive tweaks */
        @media (max-width: 576px) {
            .drawer {
                width: 85%;
                right: -85%;
            }
            
            .header-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .history-btn {
                width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-actions">
            <div class="title-container">
                <h1>Tính Tiền Lương</h1>
                <div class="subtitle">by NOVA VISION</div>
            </div>
            <button id="history-btn" class="btn history-btn">
                <i class="fas fa-history"></i> Lịch Sử
            </button>
        </div>
        
        <div id="main-view">
            <div class="card">
                <div class="input-group">
                    <label for="total-revenue">Tổng Doanh Thu (VNĐ)</label>
                    <input type="text" id="total-revenue" class="currency-input" placeholder="Nhập tổng doanh thu...">
                </div>
            </div>

            <div id="members-container">
                <!-- Member cards will be added here -->
            </div>

            <button id="add-member" class="btn add-member-btn">
                <i class="fas fa-plus"></i> Thêm Thành Viên
            </button>

            <button id="calculate" class="btn btn-success calculate-btn">
                <i class="fas fa-calculator"></i> Tính Tiền Lương
            </button>

            <div id="results" class="results hidden">
                <h2>Kết Quả Tính Toán</h2>
                <div id="results-container">
                    <!-- Result cards will be added here -->
                </div>

                <div class="card summary-card">
                    <h3>Tổng Kết</h3>
                    <div id="summary-details" class="result-details">
                        <!-- Summary details will be added here -->
                    </div>
                    
                    <div class="action-buttons">
                        <button id="export-btn" class="btn export-btn">
                            <i class="fas fa-file-export"></i> Xuất Kết Quả
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="detail-view" class="detail-view">
            <button id="back-btn" class="btn back-btn">
                <i class="fas fa-arrow-left"></i> Quay Lại
            </button>
            <h2 id="detail-month-title" class="detail-month-title">Chi Tiết Tháng</h2>
            
            <div id="detail-results-container">
                <!-- Detail result cards will be added here -->
            </div>

            <div id="detail-summary" class="card summary-card">
                <!-- Detail summary will be added here -->
            </div>
        </div>
    </div>

    <!-- History Drawer -->
    <div id="history-drawer" class="drawer">
        <div class="drawer-header">
            <h3><i class="fas fa-history"></i> Lịch Sử</h3>
            <button id="drawer-close" class="drawer-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="history-list">
            <!-- History items will be added here -->
        </div>
    </div>

    <div id="backdrop" class="backdrop"></div>

    <!-- Thêm file dữ liệu lịch sử -->
    <script src="salary-history-data.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cache keys
            const MEMBERS_CACHE_KEY = 'salary_calculator_members';
            
            // DOM elements
            const totalRevenueInput = document.getElementById('total-revenue');
            const membersContainer = document.getElementById('members-container');
            const addMemberBtn = document.getElementById('add-member');
            const calculateBtn = document.getElementById('calculate');
            const resultsSection = document.getElementById('results');
            const resultsContainer = document.getElementById('results-container');
            const summaryDetails = document.getElementById('summary-details');
            
            // New DOM elements for export and history features
            const historyBtn = document.getElementById('history-btn');
            const historyDrawer = document.getElementById('history-drawer');
            const drawerClose = document.getElementById('drawer-close');
            const backdrop = document.getElementById('backdrop');
            const exportBtn = document.getElementById('export-btn');
            const historyList = document.getElementById('history-list');
            const mainView = document.getElementById('main-view');
            const detailView = document.getElementById('detail-view');
            const backBtn = document.getElementById('back-btn');
            const detailMonthTitle = document.getElementById('detail-month-title');
            const detailResultsContainer = document.getElementById('detail-results-container');
            const detailSummary = document.getElementById('detail-summary');
            
            // Add input formatting for currency fields
            totalRevenueInput.addEventListener('input', formatCurrencyInput);
            
            // Load cached members or initialize with default members
            let members = loadFromCache() || [];
            if (members.length === 0) {
                // Add default 4 members if no cached members
                for (let i = 0; i < 4; i++) {
                    members.push({
                        name: '',
                        percentage: '',
                        expenses: ''
                    });
                }
            }
            
            // Current calculation results
            let currentResults = null;
            let currentTotalRevenue = 0;
            let currentTotalExpenses = 0;
            
            // History data from loaded JSON files
            let historyData = [];
            
            // Initialize the UI
            renderMembers();
            // Load history data automatically from the exports folder
            loadHistoryFromExports();
            
            // Add entrance animation for the calculator
            document.querySelectorAll('.card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });
            
            // Event listeners
            addMemberBtn.addEventListener('click', addMember);
            calculateBtn.addEventListener('click', calculateSalaries);
            
            // New event listeners for export and history features
            historyBtn.addEventListener('click', openHistoryDrawer);
            drawerClose.addEventListener('click', closeHistoryDrawer);
            backdrop.addEventListener('click', closeHistoryDrawer);
            exportBtn.addEventListener('click', exportResults);
            backBtn.addEventListener('click', showMainView);
            
            // Functions
            function renderMembers() {
                membersContainer.innerHTML = '';
                
                members.forEach((member, index) => {
                    const memberCard = document.createElement('div');
                    memberCard.className = 'card member-card';
                    memberCard.style.setProperty('--item-index', index);
                    memberCard.innerHTML = `
                        <div class="member-header">
                            <div class="member-title">Thành viên ${index + 1}</div>
                            ${index >= 4 ? `<button class="remove-member" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>` : ''}
                        </div>
                        <div class="member-inputs">
                            <div class="input-group">
                                <label for="member-name-${index}">Tên thành viên</label>
                                <input type="text" id="member-name-${index}" class="member-name" 
                                    placeholder="Nhập tên..." value="${member.name || ''}">
                            </div>
                            <div class="input-group">
                                <label for="member-percentage-${index}">% Nhận được</label>
                                <input type="number" id="member-percentage-${index}" class="member-percentage" 
                                    placeholder="Nhập %" min="0" max="100" step="0.01" value="${member.percentage || ''}">
                            </div>
                            <div class="input-group">
                                <label for="member-expenses-${index}">Số tiền đã chi (VNĐ)</label>
                                <input type="text" id="member-expenses-${index}" class="member-expenses currency-input" 
                                    placeholder="Nhập số tiền..." value="${member.expenses || ''}">
                            </div>
                        </div>
                    `;
                    
                    membersContainer.appendChild(memberCard);
                });
                
                // Add event listeners for remove buttons and input changes
                document.querySelectorAll('.remove-member').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        members.splice(index, 1);
                        saveToCache();
                        renderMembers();
                    });
                });
                
                document.querySelectorAll('.member-name, .member-percentage').forEach(input => {
                    input.addEventListener('change', updateMemberData);
                });
                
                document.querySelectorAll('.currency-input').forEach(input => {
                    input.addEventListener('input', formatCurrencyInput);
                    input.addEventListener('change', updateMemberData);
                });
            }
            
            function formatCurrencyInput() {
                // Check if the input contains formula operators
                if (this.value.includes('+') || this.value.includes('-') || 
                    this.value.includes('*') || this.value.includes('/') ||
                    this.value.includes('(') || this.value.includes(')')) {
                    // If it's a formula, don't format it
                    return;
                }
                
                // Get the raw input value and remove all non-digit characters
                let value = this.value.replace(/\D/g, '');
                
                // If empty, do nothing
                if (!value) {
                    this.value = '';
                    return;
                }
                
                // Format with periods for thousands
                this.value = formatDisplayNumber(value);
            }
            
            function formatDisplayNumber(value) {
                // Convert to string and ensure it's a number
                const numValue = String(parseInt(String(value).replace(/\D/g, ''), 10) || 0);
                
                // Add thousand separators
                return numValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }
            
            function parseCurrencyValue(formattedValue) {
                // Check if the input contains formula operators
                if (typeof formattedValue === 'string' && 
                   (formattedValue.includes('+') || formattedValue.includes('-') || 
                    formattedValue.includes('*') || formattedValue.includes('/') ||
                    formattedValue.includes('(') || formattedValue.includes(')'))) {
                    // If it's a formula, evaluate it
                    try {
                        return evaluateFormula(formattedValue);
                    } catch (error) {
                        console.error('Formula evaluation error:', error);
                        return 0;
                    }
                }
                
                // Remove all non-digit characters and parse as integer
                return parseInt(String(formattedValue).replace(/\D/g, ''), 10) || 0;
            }
            
            // New function to evaluate mathematical expressions
            function evaluateFormula(formula) {
                // Replace all number formats (e.g., "1.000.000" to "1000000")
                let cleanFormula = formula.replace(/(\d+)\.(?=\d{3})/g, '$1');
                while (cleanFormula !== (cleanFormula = cleanFormula.replace(/(\d+)\.(?=\d{3})/g, '$1')));
                
                // Replace Vietnamese decimal comma with dot if present
                cleanFormula = cleanFormula.replace(/,/g, '.');
                
                // Validate the formula to prevent code injection
                if (!/^[\d\s\.\+\-\*\/\(\)]+$/.test(cleanFormula)) {
                    throw new Error('Invalid formula: contains disallowed characters');
                }
                
                // Evaluate the formula
                try {
                    // Use Function instead of eval for better security
                    const result = new Function('return ' + cleanFormula)();
                    
                    // Round to nearest integer
                    return Math.round(result);
                } catch (error) {
                    console.error('Error evaluating formula:', error);
                    throw error;
                }
            }
            
            function addMember() {
                members.push({
                    name: '',
                    percentage: '',
                    expenses: ''
                });
                
                saveToCache();
                renderMembers();
                
                // Scroll to the new member
                const newMemberCard = membersContainer.lastElementChild;
                newMemberCard.scrollIntoView({ behavior: 'smooth' });
            }
            
            function updateMemberData() {
                const id = this.id;
                const parts = id.split('-');
                const field = parts[1];
                const index = parseInt(parts[2]);
                
                // For currency fields, store the raw input value
                if (field === 'expenses') {
                    // Store the raw input value for expenses (could be a formula or a number)
                    members[index][field] = this.value;
                } else if (id === 'total-revenue') {
                    members[index][field] = parseCurrencyValue(this.value);
                } else {
                    members[index][field] = this.value;
                }
                
                // Only save name and percentage to cache, not expenses
                if (field !== 'expenses') {
                    saveToCache();
                }
            }
            
            function calculateSalaries() {
                // Validate inputs
                const totalRevenue = parseCurrencyValue(totalRevenueInput.value);
                if (isNaN(totalRevenue) || totalRevenue <= 0) {
                    alert('Vui lòng nhập tổng doanh thu hợp lệ!');
                    return;
                }
                
                // Update members data from inputs and filter out members without percentage
                let activeMembers = [];
                
                members.forEach((member, index) => {
                    const nameInput = document.getElementById(`member-name-${index}`);
                    const percentageInput = document.getElementById(`member-percentage-${index}`);
                    const expensesInput = document.getElementById(`member-expenses-${index}`);
                    
                    if (nameInput && percentageInput && expensesInput) {
                        const name = nameInput.value.trim();
                        const percentage = parseFloat(percentageInput.value) || 0;
                        
                        // Get the raw expenses value (could be a formula or formatted number)
                        const rawExpenses = expensesInput.value;
                        // Parse the expenses value (evaluates formula if present)
                        const expenses = parseCurrencyValue(rawExpenses) || 0;
                        
                        // Only include members with percentage filled out
                        if (percentage > 0) {
                            activeMembers.push({
                                name: name || `Thành viên ${index + 1}`,
                                percentage: percentage,
                                expenses: expenses,
                                rawExpenses: rawExpenses // Store the raw input for reference
                            });
                        }
                    }
                });
                
                // Check if we have any active members
                if (activeMembers.length === 0) {
                    alert('Vui lòng nhập % nhận được cho ít nhất một thành viên!');
                    return;
                }
                
                // Calculate total expenses
                const totalExpenses = activeMembers.reduce((sum, member) => sum + member.expenses, 0);
                const expensesPerMember = totalExpenses / activeMembers.length;
                
                // Calculate final amounts
                const results = activeMembers.map(member => {
                    const percentageAmount = (member.percentage / 100) * totalRevenue;
                    const finalAmount = percentageAmount + member.expenses - expensesPerMember;
                    
                    return {
                        ...member,
                        percentageAmount,
                        expensesShare: expensesPerMember,
                        finalAmount
                    };
                });
                
                // Store current results for export
                currentResults = results;
                currentTotalRevenue = totalRevenue;
                currentTotalExpenses = totalExpenses;
                
                // Display results
                displayResults(results, totalRevenue, totalExpenses);
                
                // Save updated data (only names and percentages)
                saveToCache();
            }
            
            function displayResults(results, totalRevenue, totalExpenses) {
                resultsContainer.innerHTML = '';
                
                results.forEach((result, index) => {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'card result-card';
                    resultCard.style.setProperty('--item-index', index);
                    
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <div class="result-name">${result.name}</div>
                            <div class="result-amount">
                                <span class="amount-value">${formatCurrency(result.finalAmount)}</span>
                                <span class="amount-currency">VNĐ</span>
                            </div>
                        </div>
                        <div class="result-details">
                            <div class="detail-item">
                                <span>Theo % doanh thu (${result.percentage}%):</span>
                                <span>${formatCurrency(result.percentageAmount)} VNĐ</span>
                            </div>
                            <div class="detail-item">
                                <span>Đã chi:</span>
                                <span>+ ${formatCurrency(result.expenses)} VNĐ</span>
                            </div>
                            <div class="detail-item">
                                <span>Chia đều chi phí:</span>
                                <span>- ${formatCurrency(result.expensesShare)} VNĐ</span>
                            </div>
                        </div>
                    `;
                    
                    resultsContainer.appendChild(resultCard);
                });
                
                // Update summary
                summaryDetails.innerHTML = `
                    <div class="detail-item">
                        <span>Tổng doanh thu:</span>
                        <span>${formatCurrency(totalRevenue)} VNĐ</span>
                    </div>
                    <div class="detail-item">
                        <span>Tổng chi phí:</span>
                        <span>${formatCurrency(totalExpenses)} VNĐ</span>
                    </div>
                    <div class="detail-item">
                        <span>Chi phí mỗi người:</span>
                        <span>${formatCurrency(totalExpenses / results.length)} VNĐ</span>
                    </div>
                `;
                
                // Show results section with animation
                resultsSection.classList.remove('hidden');
                setTimeout(() => {
                    resultsSection.classList.add('visible');
                }, 100);
                
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            function formatCurrency(amount) {
                // Format with our custom function to ensure consistent display with periods
                return formatDisplayNumber(amount);
            }
            
            function saveToCache() {
                const membersToSave = members.map(member => ({
                    name: member.name,
                    percentage: member.percentage
                    // Expenses are not saved to cache
                }));
                
                localStorage.setItem(MEMBERS_CACHE_KEY, JSON.stringify(membersToSave));
            }
            
            function loadFromCache() {
                const cachedData = localStorage.getItem(MEMBERS_CACHE_KEY);
                if (cachedData) {
                    const parsedData = JSON.parse(cachedData);
                    // Add empty expenses field to each member
                    return parsedData.map(member => ({
                        ...member,
                        expenses: ''
                    }));
                }
                return null;
            }
            
            // New functions for export and history features
            function exportResults() {
                if (!currentResults) {
                    alert('Vui lòng tính toán trước khi xuất kết quả!');
                    return;
                }
                
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                
                // Format dates for display and filename
                const exportDate = `${day}/${month}/${year} ${hours}:${minutes}`;
                const fileDate = `${year}${month}${day}_${hours}${minutes}`;
                
                // Create export data with date information
                const exportData = {
                    exportDate: exportDate,
                    exportMonth: month,
                    exportYear: year,
                    totalRevenue: currentTotalRevenue,
                    totalExpenses: currentTotalExpenses,
                    results: currentResults
                };
                
                // Tạo chuỗi JSON để người dùng có thể thêm vào file salary-history-data.js
                // Thêm dấu phẩy trước JSON data
                const dataForHistoryFile = ",\n" + JSON.stringify(exportData, null, 4);
                
                // Copy to clipboard
                try {
                    navigator.clipboard.writeText(dataForHistoryFile).then(() => {
                        // Thêm dữ liệu mới vào historyData
                        addNewHistoryData(exportData);
                        
                        // Hiển thị thông báo thành công
                        alert(`Đã sao chép kết quả vào clipboard!\n\n` +
                            `Để thêm dữ liệu này vào lịch sử, hãy mở file salary-history-data.js và dán đoạn mã đã sao chép vào mảng SALARY_HISTORY_DATA.`);
                    }).catch(err => {
                        console.error('Không thể sao chép vào clipboard: ', err);
                        fallbackCopyToClipboard(dataForHistoryFile);
                    });
                } catch (err) {
                    console.error('Lỗi khi sao chép vào clipboard: ', err);
                    fallbackCopyToClipboard(dataForHistoryFile);
                }
            }
            
            // Hàm hỗ trợ sao chép vào clipboard cho các trình duyệt không hỗ trợ Clipboard API
            function fallbackCopyToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                
                // Ẩn textarea khỏi view
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        // Thêm dữ liệu mới vào historyData nếu sao chép thành công
                        const exportData = JSON.parse(text.substring(2)); // Bỏ dấu phẩy và dòng mới
                        addNewHistoryData(exportData);
                        
                        alert(`Đã sao chép kết quả vào clipboard!\n\n` +
                            `Để thêm dữ liệu này vào lịch sử, hãy mở file salary-history-data.js và dán đoạn mã đã sao chép vào mảng SALARY_HISTORY_DATA.`);
                    } else {
                        alert('Không thể sao chép vào clipboard. Vui lòng thử lại hoặc sao chép thủ công.');
                    }
                } catch (err) {
                    console.error('Lỗi khi sử dụng execCommand: ', err);
                    alert('Không thể sao chép vào clipboard. Vui lòng thử lại hoặc sao chép thủ công.');
                }
                
                document.body.removeChild(textArea);
            }
            
            // Replace loadHistoryFromExports function
            function loadHistoryFromExports() {
                // Clear history data
                historyData = [];

                // Sử dụng dữ liệu từ file salary-history-data.js
                if (typeof SALARY_HISTORY_DATA !== 'undefined' && Array.isArray(SALARY_HISTORY_DATA)) {
                    // Chuyển đổi dữ liệu từ SALARY_HISTORY_DATA sang định dạng historyData
                    SALARY_HISTORY_DATA.forEach((data, index) => {
                        // Tạo fileName dựa trên thông tin ngày tháng
                        const month = data.exportMonth;
                        const year = data.exportYear;
                        const date = data.exportDate.split(' ')[0].split('/')[0];
                        const time = data.exportDate.split(' ')[1].replace(':', '');
                        
                        const fileName = `tinh_luong_${year}${month}${date}_${time}.json`;
                        
                        historyData.push({
                            fileName: fileName,
                            data: data
                        });
                    });
                    
                    console.log('Đã tải ' + historyData.length + ' bản ghi lịch sử từ file dữ liệu');
                } else {
                    console.warn('Không tìm thấy dữ liệu SALARY_HISTORY_DATA hoặc dữ liệu không phải là mảng');
                }
                
                // Update the history list
                loadHistoryList();
            }
            
            function loadHistoryList() {
                // Clear existing list
                historyList.innerHTML = '';
                
                if (historyData.length === 0) {
                    historyList.innerHTML = '<div class="history-item">Chưa có dữ liệu lịch sử.</div>';
                    return;
                }
                
                // Sort history data by date (newest first)
                historyData.sort((a, b) => {
                    const dateA = new Date(
                        parseInt(a.data.exportYear), 
                        parseInt(a.data.exportMonth) - 1, 
                        1
                    );
                    const dateB = new Date(
                        parseInt(b.data.exportYear), 
                        parseInt(b.data.exportMonth) - 1, 
                        1
                    );
                    return dateB - dateA;
                });
                
                // Create history items
                historyData.forEach((item, index) => {
                    const data = item.data;
                    
                    // Get previous month for display (as requested)
                    const exportMonth = parseInt(data.exportMonth);
                    const exportYear = parseInt(data.exportYear);
                    
                    // Calculate previous month
                    let prevMonth = exportMonth - 1;
                    let prevYear = exportYear;
                    if (prevMonth === 0) {
                        prevMonth = 12;
                        prevYear--;
                    }
                    
                    const displayMonth = String(prevMonth).padStart(2, '0');
                    const displayYear = prevYear;
                    
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.setAttribute('data-index', index);
                    
                    historyItem.innerHTML = `
                        <div class="history-item-title">Tháng ${displayMonth}/${displayYear}</div>
                        <div class="history-item-date">Xuất ngày: ${data.exportDate}</div>
                    `;
                    
                    historyItem.addEventListener('click', () => {
                        showDetailView(data, displayMonth, displayYear);
                    });
                    
                    historyList.appendChild(historyItem);
                });
            }
            
            function openHistoryDrawer() {
                historyDrawer.classList.add('open');
                backdrop.classList.add('open');
            }
            
            function closeHistoryDrawer() {
                historyDrawer.classList.remove('open');
                backdrop.classList.remove('open');
            }
            
            function showDetailView(data, displayMonth, displayYear) {
                // Set month title (previous month as requested)
                detailMonthTitle.textContent = `Chi Tiết Tháng ${displayMonth}/${displayYear}`;
                
                // Populate detail view
                detailResultsContainer.innerHTML = '';
                
                data.results.forEach((result, index) => {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'card result-card';
                    resultCard.style.setProperty('--item-index', index);
                    
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <div class="result-name">${result.name}</div>
                            <div class="result-amount">
                                <span class="amount-value">${formatCurrency(result.finalAmount)}</span>
                                <span class="amount-currency">VNĐ</span>
                            </div>
                        </div>
                        <div class="result-details">
                            <div class="detail-item">
                                <span>Theo % doanh thu (${result.percentage}%):</span>
                                <span>${formatCurrency(result.percentageAmount)} VNĐ</span>
                            </div>
                            <div class="detail-item">
                                <span>Đã chi:</span>
                                <span>+ ${formatCurrency(result.expenses)} VNĐ</span>
                            </div>
                            <div class="detail-item">
                                <span>Chia đều chi phí:</span>
                                <span>- ${formatCurrency(result.expensesShare)} VNĐ</span>
                            </div>
                        </div>
                    `;
                    
                    detailResultsContainer.appendChild(resultCard);
                });
                
                // Update summary
                detailSummary.innerHTML = `
                    <h3>Tổng Kết</h3>
                    <div class="result-details">
                        <div class="detail-item">
                            <span>Tổng doanh thu:</span>
                            <span>${formatCurrency(data.totalRevenue)} VNĐ</span>
                        </div>
                        <div class="detail-item">
                            <span>Tổng chi phí:</span>
                            <span>${formatCurrency(data.totalExpenses)} VNĐ</span>
                        </div>
                        <div class="detail-item">
                            <span>Chi phí mỗi người:</span>
                            <span>${formatCurrency(data.totalExpenses / data.results.length)} VNĐ</span>
                        </div>
                        <div class="detail-item">
                            <span>Ngày xuất:</span>
                            <span>${data.exportDate}</span>
                        </div>
                    </div>
                `;
                
                // Switch to detail view with animation
                mainView.style.display = 'none';
                detailView.classList.add('active');
                
                // Close drawer
                closeHistoryDrawer();
                
                // Update URL with hash for direct access
                const hash = `month=${displayMonth}&year=${displayYear}`;
                window.location.hash = hash;
            }
            
            function showMainView() {
                detailView.classList.remove('active');
                mainView.style.display = 'block';
                
                // Clear URL hash
                window.history.pushState("", document.title, window.location.pathname);
            }
            
            // Check if URL contains hash for direct access to detail view
            function checkUrlHash() {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const params = new URLSearchParams(hash);
                    const month = params.get('month');
                    const year = params.get('year');
                    
                    if (month && year) {
                        // Find entry where the previous month matches the target month/year
                        const targetMonth = parseInt(month);
                        const targetYear = parseInt(year);
                        
                        // Calculate export month (next month from the target)
                        let exportMonth = targetMonth + 1;
                        let exportYear = targetYear;
                        if (exportMonth > 12) {
                            exportMonth = 1;
                            exportYear++;
                        }
                        
                        // Find matching item
                        const matchingItem = historyData.find(item => {
                            const data = item.data;
                            return parseInt(data.exportMonth) === exportMonth && 
                                   parseInt(data.exportYear) === exportYear;
                        });
                        
                        if (matchingItem) {
                            showDetailView(matchingItem.data, month, year);
                        }
                    }
                }
            }
            
            // Check hash on load
            checkUrlHash();
            
            // Listen for hash changes
            window.addEventListener('hashchange', checkUrlHash);
            
            // Thêm hàm để lưu dữ liệu mới vào historyData
            function addNewHistoryData(data) {
                // Tạo fileName dựa trên thông tin ngày tháng
                const month = data.exportMonth;
                const year = data.exportYear;
                const date = data.exportDate.split(' ')[0].split('/')[0];
                const time = data.exportDate.split(' ')[1].replace(':', '');
                
                const fileName = `tinh_luong_${year}${month}${date}_${time}.json`;
                
                // Thêm vào historyData
                historyData.push({
                    fileName: fileName,
                    data: data
                });
                
                // Cập nhật danh sách lịch sử
                loadHistoryList();
            }
        });
    </script>
</body>
</html>